<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>AR Penguin Explorer</title>

  <!-- A-Frame + AR.js + Extras -->
  <script src="public/aframe-v1.7.0.min.js"></script>
  <script src="public/aframe-extras-v7.2.0.min.js"></script>
  <script src="public/aframe-ar.js"></script>
  
  <!-- Gesture Detection Components -->
  <script src="public/gesture-detector.js"></script>
  <script src="public/gesture-handler.js"></script>

  <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html, body {
  height: 100%;
  width: 100%;
  overflow: hidden;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #000;
  position: fixed;
  top: 0;
  left: 0;
  overscroll-behavior: none;
  touch-action: none;
  -webkit-overflow-scrolling: touch;
}

/* Loading screen */
#loadingScreen {
  position: fixed;
  top: 0; 
  left: 0;
  width: 100vw; 
  height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  color: white;
  text-align: center;
}

#loadingScreen h1 {
  font-size: clamp(1.8rem, 5vw, 2.5rem);
  margin-bottom: 1rem;
  font-weight: 300;
}

#loadingScreen p {
  font-size: clamp(0.9rem, 3vw, 1.1rem);
  margin-bottom: 2rem;
  opacity: 0.9;
  padding: 0 20px;
}

.spinner {
  width: 50px;
  height: 50px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top: 3px solid white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* AR Scene - Full screen setup */
a-scene {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 1 !important;
  display: block !important;
}

/* A-Frame Canvas - Full screen */
.a-canvas {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  z-index: 2 !important;
  display: block !important;
}

/* AR.js Video - Full screen background */
.arjs-video, #arjs-video {
  position: fixed !important;
  top: 0 !important;
  left: 0 !important;
  width: 100vw !important;
  height: 100vh !important;
  object-fit: cover !important;
  z-index: 0 !important;
  transform: none !important;
}

/* UI Overlay - Above everything */
.ui-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  pointer-events: none;
  z-index: 100;
  display: block;
}

.top-bar {
  position: absolute;
  top: max(env(safe-area-inset-top, 10px), 10px);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  color: white;
  padding: clamp(8px, 3vw, 12px) clamp(16px, 4vw, 24px);
  border-radius: 25px;
  font-size: clamp(0.9rem, 3.5vw, 1.1rem);
  font-weight: 600;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
  white-space: nowrap;
  max-width: 90vw;
  text-overflow: ellipsis;
  overflow: hidden;
  pointer-events: none;
}

.bottom-controls {
  position: absolute;
  bottom: max(env(safe-area-inset-bottom, 20px), 20px);
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: clamp(8px, 3vw, 15px);
  padding: 0 10px;
  pointer-events: auto;
}

.control-btn {
  background: rgba(255, 255, 255, 0.95);
  border: none;
  width: clamp(50px, 12vw, 60px);
  height: clamp(50px, 12vw, 60px);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  pointer-events: auto;
  font-size: clamp(1.2rem, 4vw, 1.5rem);
  min-width: 44px;
  min-height: 44px;
}

.control-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
  background: rgba(255, 255, 255, 1);
}

.control-btn:active {
  transform: translateY(0);
}

/* Info Panel */
.info-panel {
  position: fixed;
  top: 50%;
  right: -100%;
  transform: translateY(-50%);
  width: min(350px, 90vw);
  max-height: min(80vh, 600px);
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(15px);
  border-radius: 20px;
  padding: clamp(15px, 4vw, 25px);
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  pointer-events: auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  z-index: 101;
}

.info-panel.active {
  right: max(10px, env(safe-area-inset-right, 10px));
}

.info-panel h3 {
  margin: 0 0 clamp(10px, 3vw, 15px) 0;
  color: #2c3e50;
  font-size: clamp(1.2rem, 4vw, 1.4rem);
  font-weight: 700;
}

.info-panel p {
  margin: 0 0 clamp(8px, 2vw, 12px) 0;
  color: #34495e;
  line-height: 1.5;
  font-size: clamp(0.85rem, 3vw, 0.95rem);
}

.close-btn {
  position: absolute;
  top: clamp(10px, 3vw, 15px);
  right: clamp(10px, 3vw, 15px);
  background: none;
  border: none;
  font-size: clamp(1.3rem, 4vw, 1.5rem);
  cursor: pointer;
  color: #7f8c8d;
  width: clamp(30px, 8vw, 35px);
  height: clamp(30px, 8vw, 35px);
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: all 0.2s ease;
  z-index: 102;
  min-width: 44px;
  min-height: 44px;
  pointer-events: auto;
}

.close-btn:hover {
  background: rgba(0, 0, 0, 0.1);
  color: #2c3e50;
}

/* Info Navigation */
.info-nav {
  display: flex;
  gap: clamp(5px, 2vw, 10px);
  margin-bottom: clamp(10px, 3vw, 15px);
  flex-wrap: wrap;
}

.nav-btn {
  background: #e0e0e0;
  border: none;
  padding: clamp(6px, 2vw, 8px) clamp(8px, 2.5vw, 12px);
  border-radius: 20px;
  cursor: pointer;
  font-size: clamp(0.8rem, 3vw, 0.9rem);
  transition: all 0.2s ease;
  flex: 1;
  min-width: fit-content;
  text-align: center;
  min-height: 44px;
  pointer-events: auto;
}

.nav-btn.active {
  background: #4CAF50;
  color: white;
}

.nav-btn:hover {
  background: #d0d0d0;
}

/* Instructions */
.instructions {
  position: absolute;
  bottom: clamp(100px, 25vw, 120px);
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 0, 0, 0.7);
  backdrop-filter: blur(10px);
  color: white;
  padding: clamp(10px, 3vw, 15px) clamp(15px, 4vw, 20px);
  border-radius: 15px;
  text-align: center;
  font-size: clamp(0.8rem, 3vw, 0.9rem);
  animation: fadeInUp 0.5s ease;
  max-width: 90vw;
  width: fit-content;
  pointer-events: none;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translate(-50%, 20px);
  }
  to {
    opacity: 1;
    transform: translate(-50%, 0);
  }
}

/* Hide A-Frame VR button */
.a-enter-vr {
  display: none !important;
}

.a-enter-ar {
  display: none !important;
}

/* Mobile-specific optimizations */
@media (max-width: 768px) {
  .info-panel {
    width: calc(100vw - 40px);
    max-height: 70vh;
    top: 50%;
    transform: translateY(-50%);
    right: -100vw;
  }
  
  .info-panel.active {
    right: 20px;
    left: 20px;
    width: calc(100vw - 40px);
  }
  
  .top-bar {
    font-size: clamp(0.8rem, 4vw, 1rem);
    padding: 10px 20px;
    max-width: 95vw;
  }

  .bottom-controls {
    bottom: max(15px, env(safe-area-inset-bottom, 15px));
    gap: 10px;
    flex-wrap: nowrap;
    justify-content: center;
    width: 100%;
  }

  .control-btn {
    width: clamp(45px, 14vw, 55px);
    height: clamp(45px, 14vw, 55px);
    font-size: clamp(1.1rem, 4.5vw, 1.3rem);
  }
}

/* Tablet optimizations */
@media (min-width: 769px) and (max-width: 1024px) {
  .info-panel {
    width: min(400px, 80vw);
  }
  
  .control-btn {
    width: 55px;
    height: 55px;
    font-size: 1.3rem;
  }
}

/* Landscape mobile optimizations */
@media (max-height: 500px) and (orientation: landscape) {
  .top-bar {
    top: 5px;
    padding: 6px 15px;
    font-size: 0.9rem;
  }
  
  .bottom-controls {
    bottom: 10px;
  }
  
  .control-btn {
    width: 40px;
    height: 40px;
    font-size: 1.1rem;
  }
  
  .info-panel {
    max-height: 90vh;
    padding: 15px;
  }
  
  .instructions {
    bottom: 80px;
    padding: 8px 12px;
    font-size: 0.8rem;
  }
}

/* Custom scrollbar for webkit browsers */
.info-panel::-webkit-scrollbar {
  width: 6px;
}

.info-panel::-webkit-scrollbar-track {
  background: rgba(0, 0, 0, 0.1);
  border-radius: 3px;
}

.info-panel::-webkit-scrollbar-thumb {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 3px;
}

.info-panel::-webkit-scrollbar-thumb:hover {
  background: rgba(0, 0, 0, 0.5);
}

/* Prevent text selection */
.ui-overlay {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/* iOS Safari specific fixes */
@supports (-webkit-touch-callout: none) {
  /* Fix for iOS viewport units */
  html {
    height: -webkit-fill-available;
  }
  
  body {
    height: -webkit-fill-available;
  }
  
  .arjs-video, #arjs-video {
    object-position: center center !important;
  }
  
  /* Ensure proper full screen on iOS */
  a-scene {
    height: -webkit-fill-available !important;
  }
}

/* Hide potential system scrollbars */
::-webkit-scrollbar {
  display: none;
}

body {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

/* Force hardware acceleration */
a-scene, .a-canvas, .arjs-video {
  -webkit-transform: translateZ(0);
  -moz-transform: translateZ(0);
  -ms-transform: translateZ(0);
  transform: translateZ(0);
  -webkit-backface-visibility: hidden;
  -moz-backface-visibility: hidden;
  backface-visibility: hidden;
}
  </style>
</head>
<body>
  <!-- Loading Screen -->
  <div id="loadingScreen">
    <h1>üêß AR Penguin Explorer</h1>
    <p>Initializing AR camera and marker detection...</p>
    <div class="spinner"></div>
  </div>

  <!-- UI Overlay -->
  <div class="ui-overlay">
    <div class="top-bar">
      African Penguin AR Experience
    </div>

    <div class="instructions" id="instructions">
      Point your camera at the marker and tap the info button to learn about the African penguins!
    </div>

    <div class="bottom-controls">
      <button class="control-btn" id="infoBtn" title="Penguin Information">
        ‚ÑπÔ∏è
      </button>
      <button class="control-btn" id="resetBtn" title="Reset View">
        üîÑ
      </button>
      <button class="control-btn" id="rotateBtn" title="Rotate Penguin">
        ‚Ü™Ô∏è
      </button>
    </div>

    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
      <button class="close-btn" id="closeBtn">√ó</button>
      <div id="infoContent">
        <h3>African Penguin Facts</h3>
        <div class="info-nav">
          <button class="nav-btn" data-info="general">General</button>
          <button class="nav-btn" data-info="habitat">Habitat</button>
          <button class="nav-btn" data-info="behavior">Behavior</button>
        </div>
        <div id="infoText"></div>
      </div>
    </div>
  </div>

  <!-- AR Scene -->
  <a-scene
    embedded
    arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;"
    renderer="logarithmicDepthBuffer: true; antialias: true; alpha: true; colorManagement: true; sortObjects: true;"
    vr-mode-ui="enabled: false"
    gesture-detector
    id="scene"
    background="transparent: true"
    loading-screen="enabled: false"
  >
    
    <!-- Assets -->
    <a-assets>
      <!-- Penguin 3D Model -->
      <a-asset-item id="penguin-model" src="assets/african_penguin_spheniscus_demersus_low_poly.glb"></a-asset-item>
    </a-assets>

    <!-- Camera -->
    <a-entity camera position="0 0 0" look-controls="enabled: false" cursor="rayOrigin: mouse"></a-entity>

    <!-- Hiro Marker -->
    <a-marker 
      preset="hiro" 
      id="hiro-marker" 
      raycaster="objects: .clickable"
      emitevents="true"
      cursor="fuse: false; rayOrigin: mouse;"
    >
      
      <a-entity
        id="penguin"
        gltf-model="#penguin-model"
        position="0 0 0"
        rotation="-90 0 0"
        scale="5 5 5" 
        animation-mixer="loop: repeat"
        class="clickable"
        gesture-handler
      >
      </a-entity>

      <!-- Lights -->
      <a-light type="ambient" color="#ffffff" intensity="0.8"></a-light>
      <a-light type="directional" position="0 5 0" color="#ffffff" intensity="0.6"></a-light>
    </a-marker>

  </a-scene>

  <script type="module" src="script.js"></script>
  
  <script>
    // Additional viewport and fullscreen fixes
    function setupFullscreen() {
      // Force proper viewport on mobile
      const viewport = document.querySelector('meta[name="viewport"]');
      if (viewport) {
        viewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover');
      }
      
      // Hide loading screen after A-Frame loads
      document.querySelector('a-scene').addEventListener('loaded', function () {
        setTimeout(() => {
          const loadingScreen = document.getElementById('loadingScreen');
          if (loadingScreen) {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
            }, 500);
          }
        }, 1000);
      });
      
      // Prevent zoom and scroll
      document.addEventListener('touchmove', function(e) {
        if (e.target.closest('.info-panel')) return;
        e.preventDefault();
      }, { passive: false });
      
      document.addEventListener('gesturestart', function(e) {
        e.preventDefault();
      });
      
      document.addEventListener('gesturechange', function(e) {
        e.preventDefault();
      });
      
      document.addEventListener('gestureend', function(e) {
        e.preventDefault();
      });
    }
    
    // Run setup when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupFullscreen);
    } else {
      setupFullscreen();
    }
  </script>
</body>
</html>